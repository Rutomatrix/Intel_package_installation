<!DOCTYPE html>
<html>
<head>
  <title>Virtual desk and OS Flashin</title>
  <link rel="icon" type="image/x-icon" href="/static/images/rutomatrix.ico">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #121212;
      color: #FFFFFF;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .main-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 16px;
      box-sizing: border-box;
      gap: 16px;
      max-width: 2000px;
      margin: 0 auto;
    }

    /* Tabs Styling */
    .tabs-container {
      display: flex;
      background: #1E1E1E;
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .tab-btn {
      flex: 1;
      background: transparent;
      border: none;
      color: #BBBBBB;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn:hover {
      background: rgba(255, 106, 0, 0.1);
      color: #FFFFFF;
    }

    .tab-btn.active {
      background: #FF6A00;
      color: #FFFFFF;
    }

    .tab-icon {
      width: 18px;
      height: 18px;
    }

    /* Content Area */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      gap: 16px;
    }

    .tab-content.active {
      display: flex;
    }

    /* Shared Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #1E1E1E;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .device-info {
      display: flex;
      flex-direction: column;
    }

    .device-name-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .device-name {
      font-size: 18px;
      font-weight: 600;
      color: #FF6A00;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      word-break: break-word;
      line-height: 1.2;
      text-align: center;
    }

    #device-timer {
      margin-left: 10px;
      font-size: 14px;
      color: #BBBBBB;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* PC Remote Desktop Specific Styles */
    .pc-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .control-btn {
      background: #2A2A2A;
      border: none;
      color: #FFFFFF;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .control-btn:hover {
      background: #FF6A00;
    }

    .control-btn.active {
      background: #FF6A00;
    }

    .dropdown-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 180px;
    }

    .dropdown-label {
      font-size: 12px;
      color: #BBBBBB;
      font-weight: 500;
    }

    .dropdown-select {
      background: #2A2A2A;
      border: 1px solid #404040;
      color: #FFFFFF;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      outline: none;
    }

    .dropdown-select:hover {
      border-color: #FF6A00;
      background: #333333;
    }

    .dropdown-select:focus {
      border-color: #FF6A00;
      box-shadow: 0 0 0 2px rgba(255, 106, 0, 0.2);
    }

    .dropdown-select option {
      background: #2A2A2A;
      color: #FFFFFF;
      padding: 8px;
    }

    /* Remote Desktop Container - Like in the image */
    .remote-desktop-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #000000;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #404040;
    }

    .remote-desktop-header {
      padding: 12px 16px;
      background: #1E1E1E;
      font-size: 14px;
      color: #FFFFFF;
      border-bottom: 1px solid #404040;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .remote-desktop-content {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #000000;
    }

    /* Desktop view - fills the entire area */
    .desktop-view {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .desktop-placeholder {
      color: #888888;
      font-size: 16px;
      font-style: italic;
    }

    #remoteDesktopImg {
      width: 100%;
      height: 100%;
      object-fit: contain;
      cursor: pointer;
    }

    /* Shortcut Feedback Popup - appears inside desktop view */
    .shortcut-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    .shortcut-popup {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #FF6A00;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      z-index: 101;
      display: none;
      animation: slideDown 0.3s ease-out;
      box-shadow: 0 4px 20px rgba(0,0,0,0.7);
      border: 2px solid #FF6A00;
      white-space: nowrap;
    }

    @keyframes slideDown {
      0% {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }

    /* Connection status */
    .connection-status {
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 4px;
      font-size: 12px;
      color: #BBBBBB;
    }

    .connected {
      color: #00FF00;
    }

    .disconnected {
      color: #FF4444;
    }

    /* Loading spinner */
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #FF6A00;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* OS Mounting Specific Styles */
    .os-container {
      background: #1E1E1E;
      border: 2px solid #0971b3;
      border-radius: 12px;
      padding: 0px 40px 40px 40px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      text-align: center;
      margin: 0 auto;
    }

    .os-controls {
      display: flex;
      gap: 12px;
    }

    h2 {
      color: #FFFFFF;
      font-size: 20px;
      font-weight: 500;
      margin: 30px 0 20px 0;
    }

    .os-btn {
      background: #ff6a00;
      border: none;
      color: #FFFFFF;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
      min-width: 100px;
    }

    .os-btn:hover:not(:disabled) {
      background: #e55a00;
    }

    .os-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #unmountBtn {
      background: #0971b3;
    }

    #unmountBtn:hover {
      background: #085a94;
    }

    .iso-container {
      background: #2A2A2A;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      cursor: pointer;
      padding: 12px 16px;
      border: 1px solid #444;
      margin: 8px 0;
      border-radius: 6px;
      background: #1A1A1A;
      transition: all 0.3s ease;
      text-align: left;
    }

    li:hover {
      border-color: #ff6a00;
      background: #333;
    }

    li.selected {
      background: #0971b3;
      border-color: #0971b3;
      color: #FFFFFF;
      font-weight: bold;
    }

    .status {
      background: #2A2A2A;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
      min-height: 20px;
      color: #ff6a00;
      font-weight: 500;
    }

    .empty-state {
      color: #888;
      font-style: italic;
      padding: 40px 20px;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Tabs Navigation -->
    <div class="tabs-container">
      <button class="tab-btn active" id="pc-tab" onclick="switchTab('pc')">
        <svg class="tab-icon" viewBox="0 0 24 24">
          <path fill="currentColor" d="M20,18H4V6H20M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z"/>
        </svg>
        Remote Desktop
      </button>
      <button class="tab-btn" id="os-tab" onclick="switchTab('os')">
        <svg class="tab-icon" viewBox="0 0 24 24">
          <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
        </svg>
        OS Mounting
      </button>
    </div>

    <!-- PC Remote Desktop Content -->
    <div class="tab-content active" id="pc-content">
      <div class="header">
        <div class="device-info">
          <div class="device-name-row">
            <div class="device-name">Rutomatrix</div>
            <div id="device-timer"></div>
          </div>
        </div>
        <div class="pc-controls">
          <button class="control-btn" id="connect-btn">
            <svg viewBox="0 0 24 24" width="16" height="16">
              <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Connect
          </button>
          
          <div class="dropdown-container">
            <label class="dropdown-label" for="shortcutSelect">System Shortcuts</label>
            <select class="dropdown-select" id="shortcutSelect" onchange="sendShortcut(this.value)">
              <option value="">-- Select a Shortcut --</option>
              <option value="esc">Esc</option>
              <option value="ctrl_alt_del">Ctrl + Alt + Del</option>
              <option value="ctrl_shift_esc">Ctrl + Shift + Esc</option>
              <option value="alt_f4">Alt + F4</option>
              <option value="win_l">Win + L</option>
              <option value="win_d">Win + D</option>
              <option value="win_tab">Win + Tab</option>
              <option value="alt_tab">Alt + Tab</option>
              <option value="alt_esc">Alt + Esc</option>
              <option value="win_ctrl_d">Win + Ctrl + D</option>
              <option value="win_ctrl_left">Win + Ctrl + Left</option>
              <option value="win_ctrl_right">Win + Ctrl + Right</option>
              <option value="win_up">Win + Up</option>
              <option value="win_down">Win + Down</option>
              <option value="win_left">Win + Left</option>
              <option value="win_right">Win + Right</option>
              <option value="fn_f1_f12">Fn + F1–F12</option>
              <option value="ctrl_alt_right">Ctrl + Alt + →</option>
              <option value="ctrl_alt_left">Ctrl + Alt + ←</option>
              <option value="ctrl_n">Ctrl + N</option>
              <option value="ctrl_w">Ctrl + W</option>
              <option value="ctrl_t">Ctrl + T</option>
              <option value="ctrl_shift_t">Ctrl + Shift + T</option>
            </select>
          </div>

          <div class="dropdown-container">
            <label class="dropdown-label" for="functionKeySelect">Function Keys</label>
            <select class="dropdown-select" id="functionKeySelect" onchange="sendShortcut(this.value)">
              <option value="">-- Select Function Key --</option>
              <option value="f1">F1</option>
              <option value="f2">F2</option>
              <option value="f3">F3</option>
              <option value="f4">F4</option>
              <option value="f5">F5</option>
              <option value="f6">F6</option>
              <option value="f7">F7</option>
              <option value="f8">F8</option>
              <option value="f9">F9</option>
              <option value="f10">F10</option>
              <option value="f11">F11</option>
              <option value="f12">F12</option>
            </select>
          </div>
        </div>
      </div>

      <div class="remote-desktop-wrapper">
        <div class="remote-desktop-header">
          <span>Remote Desktop</span>
          <div class="connection-status disconnected" id="connection-status">Disconnected</div>
        </div>
        <div class="remote-desktop-content">
          <div class="shortcut-overlay">
            <div class="shortcut-popup" id="shortcut-popup"></div>
          </div>
          <div class="desktop-view" id="desktop-view">
            <div class="desktop-placeholder" id="remote-desktop-feed">Not connected</div>
          </div>
        </div>
      </div>
    </div>

    <!-- OS Mounting Content -->
    <div class="tab-content" id="os-content">
      <div class="header">
        <div class="device-info">
          <div class="device-name-row">
            <div class="device-name">Rutomatrix</div>
            <div id="os-device-timer"></div>
          </div>
        </div>
        <div class="os-controls">
          <button class="control-btn" onclick="fetchList()">List OS</button>
          <button class="control-btn" onclick="mountSelected()" id="mountBtn" disabled>Mount</button>
          <button class="control-btn" onclick="unmount()" id="unmountBtn" disabled>Unmount</button>
        </div>
      </div>

      <div class="os-container">
        <h2>Available ISO files:</h2>
        <div class="iso-container">
          <ul id="isoList">
            <div class="empty-state">Click "List OS" to load available ISO files</div>
          </ul>
        </div>
        <div class="status" id="status">Ready</div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching functionality
    function switchTab(tabName) {
      // Update tabs
      document.getElementById('pc-tab').classList.toggle('active', tabName === 'pc');
      document.getElementById('os-tab').classList.toggle('active', tabName === 'os');
      
      // Update content
      document.getElementById('pc-content').classList.toggle('active', tabName === 'pc');
      document.getElementById('os-content').classList.toggle('active', tabName === 'os');
      
      // If switching to OS tab, ensure timer ID is unique
      if (tabName === 'os') {
        const osTimerElement = document.getElementById('os-device-timer');
        const mainTimerElement = document.getElementById('device-timer');
        if (mainTimerElement && osTimerElement) {
          osTimerElement.innerHTML = mainTimerElement.innerHTML;
        }
      }
    }

    // PC Remote Desktop functionality
    document.addEventListener('DOMContentLoaded', () => {
      const connectBtn = document.getElementById('connect-btn');
      const remoteDesktopFeed = document.getElementById('remote-desktop-feed');
      const desktopView = document.getElementById('desktop-view');
      const connectionStatus = document.getElementById('connection-status');
      const shortcutPopup = document.getElementById('shortcut-popup');
      let isConnected = false;
      let videoElement = null;
      let refreshInterval = null;
      
      // Connect/Disconnect control
      connectBtn.addEventListener('click', async () => {
        if (!isConnected) {
          // Connect
          remoteDesktopFeed.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;">' +
            '<div class="loading-spinner"></div>' +
            '<p style="color: #FF6A00; font-weight: bold;">Connecting ...</p>' +
            '</div>';
          
          connectionStatus.textContent = 'Connecting...';
          connectionStatus.className = 'connection-status';

          try {
            const data = await testConnection(`/start_stream`);
            const data1 = await testConnection1(`/start_stream`);
            
            if (data1.status === 'already running' || data1.status === 'started') {
              // Create video element
              videoElement = document.createElement('img');
              videoElement.id = 'remoteDesktopImg';
              videoElement.src = `http://${window.location.hostname}:9000/stream?advance_headers=1&dual_final_frames=1&t=` + Date.now();
              videoElement.style.width = '100%';
              videoElement.style.height = '100%';
              videoElement.style.objectFit = 'contain';
              videoElement.style.cursor = 'pointer';
              
              // Clear placeholder and add video
              remoteDesktopFeed.remove();
              desktopView.appendChild(videoElement);
              
              // Update UI
              connectBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Disconnect';
              connectBtn.classList.add('active');
              connectionStatus.textContent = 'Connected';
              connectionStatus.className = 'connection-status connected';
              isConnected = true;
              
              setupMouseAndKeyboard();
              
              // Auto-refresh the stream every 30 seconds
              refreshInterval = setInterval(() => {
                if (videoElement && isConnected) {
                  videoElement.src = `http://${window.location.hostname}:9000/stream?advance_headers=1&dual_final_frames=1&t=` + Date.now();
                }
              }, 30000);
            } else {
              throw new Error('Stream failed to start');
            }
          } catch (error) {
            console.error('Connection error:', error);
            remoteDesktopFeed.innerHTML = '<div class="desktop-placeholder" style="color: #FF4444;">Connection failed: ' + error.message + '</div>';
            connectionStatus.textContent = 'Connection failed';
            connectionStatus.className = 'connection-status';
          }
        } else {
          // Disconnect
          await disconnect();
        }
      });

      // Show shortcut feedback popup
      function showShortcutPopup(shortcutName) {
        const shortcutNames = {
          'esc': 'Esc',
          'ctrl_alt_del': 'Ctrl + Alt + Del',
          'ctrl_shift_esc': 'Ctrl + Shift + Esc',
          'alt_f4': 'Alt + F4',
          'win_l': 'Win + L',
          'win_d': 'Win + D',
          'win_tab': 'Win + Tab',
          'alt_tab': 'Alt + Tab',
          'alt_esc': 'Alt + Esc',
          'win_ctrl_d': 'Win + Ctrl + D',
          'win_ctrl_left': 'Win + Ctrl + Left',
          'win_ctrl_right': 'Win + Ctrl + Right',
          'win_up': 'Win + Up',
          'win_down': 'Win + Down',
          'win_left': 'Win + Left',
          'win_right': 'Win + Right',
          'fn_f1_f12': 'Fn + F1–F12',
          'ctrl_alt_right': 'Ctrl + Alt + →',
          'ctrl_alt_left': 'Ctrl + Alt + ←',
          'ctrl_n': 'Ctrl + N',
          'ctrl_w': 'Ctrl + W',
          'ctrl_t': 'Ctrl + T',
          'ctrl_shift_t': 'Ctrl + Shift + T',
          'f1': 'F1', 'f2': 'F2', 'f3': 'F3', 'f4': 'F4', 'f5': 'F5',
          'f6': 'F6', 'f7': 'F7', 'f8': 'F8', 'f9': 'F9', 'f10': 'F10',
          'f11': 'F11', 'f12': 'F12'
        };

        const displayName = shortcutNames[shortcutName] || shortcutName.replace(/_/g, ' ').toUpperCase();
        shortcutPopup.textContent = displayName + ' ✓';
        shortcutPopup.style.display = 'block';
        
        // Auto hide after 1.5 seconds
        setTimeout(() => {
          shortcutPopup.style.display = 'none';
        }, 1500);
      }

      async function disconnect() {
        // Clear refresh interval
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }
        
        // Remove video element
        if (videoElement) {
          videoElement.remove();
          videoElement = null;
        }
        
        // Reset UI
        desktopView.innerHTML = '<div class="desktop-placeholder" id="remote-desktop-feed">Not connected</div>';
        connectBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Connect';
        connectBtn.classList.remove('active');
        connectionStatus.textContent = 'Disconnected';
        connectionStatus.className = 'connection-status disconnected';
        isConnected = false;
      }

      function setupMouseAndKeyboard() {
        if (!videoElement) return;

        videoElement.addEventListener('click', () => {
          videoElement.requestPointerLock = videoElement.requestPointerLock || 
                                           videoElement.mozRequestPointerLock || 
                                           videoElement.webkitRequestPointerLock;
          videoElement.requestPointerLock();
        });

        document.addEventListener('keydown', function (e) {
          if (document.pointerLockElement === videoElement) {
            const jsCodes = [];
            if (e.ctrlKey) jsCodes.push(17);
            if (e.shiftKey) jsCodes.push(16);
            if (e.altKey) jsCodes.push(18);
            if (e.metaKey || e.key === 'Meta') jsCodes.push(91);
            const isModifier = [16, 17, 18, 91].includes(e.keyCode);
            if (!isModifier) jsCodes.push(e.keyCode);

            if (jsCodes.length > 0) {
              fetch(`http://${window.location.hostname}:5000/keyboard`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keycodes: jsCodes })
              });
            }
          }
        });

        function smoothMouseDelta(dx, dy, threshold = 1) {
          dx = Math.abs(dx) >= threshold ? dx : 0;
          dy = Math.abs(dy) >= threshold ? dy : 0;
          return [dx, dy];
        }

        document.addEventListener('mousemove', (e) => {
          if (document.pointerLockElement === videoElement) {
            let [dx, dy] = smoothMouseDelta(e.movementX, e.movementY);
            fetch(`http://${window.location.hostname}:5000/mouse`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ x: dx, y: dy, buttons: e.buttons, wheel: 0 })
            });
          }
        });

        document.addEventListener('mousedown', (e) => {
          if (document.pointerLockElement === videoElement) {
            fetch(`http://${window.location.hostname}:5000/mouse`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ x: 0, y: 0, buttons: (1 << e.button), wheel: 0 })
            });
          }
        });

        document.addEventListener('mouseup', (e) => {
          if (document.pointerLockElement === videoElement) {
            fetch(`http://${window.location.hostname}:5000/mouse`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ x: 0, y: 0, buttons: 0, wheel: 0 })
            });
          }
        });

        document.addEventListener('wheel', (e) => {
          if (document.pointerLockElement === videoElement) {
            fetch(`http://${window.location.hostname}:5000/mouse`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ x: 0, y: 0, buttons: 0, wheel: e.deltaY > 0 ? 0xFF : 0x01 })
            });
            e.preventDefault();
          }
        });
      }
    });

    async function testConnection(url) {
      // Define the necessary variables (ensure these are available/defined in a higher scope)
      const DRIVER_PORT = 8000; 
      const API_BASE_URL = `${window.location.protocol}//${window.location.hostname}:${DRIVER_PORT}`;
    
      // Construct the absolute URL using the base and the relative path passed to the function
      const absolute_url = `${API_BASE_URL}${url}`;
      try {
        const response = await fetch(absolute_url, {
          method: 'POST',
          cache: 'no-store'
        });
        const data = await response.json();
        return data;
      } catch (error) {
        return {
          ok: false,
          status: 0,
          statusText: error.message
        };
      }
    }

    async function testConnection1(url) {
      // Define the necessary variables for cross-port communication
      const DRIVER_PORT = 5000; 
      const API_BASE_URL = `${window.location.protocol}//${window.location.hostname}:${DRIVER_PORT}`;
      
      // Construct the absolute URL
      const absolute_url = `${API_BASE_URL}${url}`;
      try {
        const response = await fetch(absolute_url, {
          method: 'GET',
          cache: 'no-store'
        });
        const data = await response.json();
        return data;
      } catch (error) {
        return {
          ok: false,
          status: 0,
          statusText: error.message
        };
      }
    }

    function sendShortcut(action) {
      if (!action) return;
      
      // Show popup feedback
      showShortcutPopup(action);

      fetch(`http://${window.location.hostname}:5000/shortcut/` + action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.text())
      .then(data => {
        console.log('Shortcut sent:', action, 'Response:', data);
        // Reset dropdowns
        document.getElementById('shortcutSelect').value = '';
        document.getElementById('functionKeySelect').value = '';
      })
      .catch(err => console.error('Shortcut error:', err));
    }

    // Global function to show shortcut popup
    function showShortcutPopup(shortcutName) {
      const popup = document.getElementById('shortcut-popup');
      if (!popup) return;
      
      const shortcutNames = {
        'esc': 'Esc',
        'ctrl_alt_del': 'Ctrl + Alt + Del',
        'ctrl_shift_esc': 'Ctrl + Shift + Esc',
        'alt_f4': 'Alt + F4',
        'win_l': 'Win + L',
        'win_d': 'Win + D',
        'win_tab': 'Win + Tab',
        'alt_tab': 'Alt + Tab',
        'alt_esc': 'Alt + Esc',
        'win_ctrl_d': 'Win + Ctrl + D',
        'win_ctrl_left': 'Win + Ctrl + Left',
        'win_ctrl_right': 'Win + Ctrl + Right',
        'win_up': 'Win + Up',
        'win_down': 'Win + Down',
        'win_left': 'Win + Left',
        'win_right': 'Win + Right',
        'fn_f1_f12': 'Fn + F1–F12',
        'ctrl_alt_right': 'Ctrl + Alt + →',
        'ctrl_alt_left': 'Ctrl + Alt + ←',
        'ctrl_n': 'Ctrl + N',
        'ctrl_w': 'Ctrl + W',
        'ctrl_t': 'Ctrl + T',
        'ctrl_shift_t': 'Ctrl + Shift + T',
        'f1': 'F1', 'f2': 'F2', 'f3': 'F3', 'f4': 'F4', 'f5': 'F5',
        'f6': 'F6', 'f7': 'F7', 'f8': 'F8', 'f9': 'F9', 'f10': 'F10',
        'f11': 'F11', 'f12': 'F12'
      };

      const displayName = shortcutNames[shortcutName] || shortcutName.replace(/_/g, ' ').toUpperCase();
      popup.textContent = displayName + ' ✓';
      popup.style.display = 'block';
      
      setTimeout(() => {
        popup.style.display = 'none';
      }, 1500);
    }

    // OS Mounting functionality
    let selectedFile = null;

    function fetchList() {
      document.getElementById('status').textContent = 'Loading ISO files...';
      fetch(`http://${window.location.hostname}:9001/list`)
        .then(res => res.json())
        .then(data => {
          const ul = document.getElementById('isoList');
          ul.innerHTML = '';
          selectedFile = null;
          document.getElementById('mountBtn').disabled = true;

          if (data.available_isos && data.available_isos.length > 0) {
            data.available_isos.forEach(file => {
              const li = document.createElement('li');
              li.textContent = file;
              li.onclick = () => {
                [...ul.children].forEach(child => child.classList.remove('selected'));
                li.classList.add('selected');
                selectedFile = file;
                document.getElementById('mountBtn').disabled = false;
                document.getElementById('status').textContent = 'Selected: ' + file;
              };
              ul.appendChild(li);
            });
            document.getElementById('status').textContent = 'Found ' + data.available_isos.length + ' ISO files';
          } else {
            ul.innerHTML = '<div class="empty-state">No ISO files found</div>';
            document.getElementById('status').textContent = 'No ISO files available';
          }
        })
        .catch(err => {
          document.getElementById('status').textContent = 'Failed to fetch list';
          document.getElementById('isoList').innerHTML = '<div class="empty-state">Error loading ISO files</div>';
          console.error(err);
        });
    }

    function mountSelected() {
      if (!selectedFile) {
        document.getElementById('status').textContent = 'No file selected';
        return;
      }

      document.getElementById('status').textContent = 'Mounting ' + selectedFile + '...';

      fetch(`http://${window.location.hostname}:9001/mount?filename=` + encodeURIComponent(selectedFile), {
        method: 'POST'
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('status').textContent = 'Successfully mounted: ' + data.iso;
        document.getElementById('unmountBtn').disabled = false;
      })
      .catch(err => {
        document.getElementById('status').textContent = 'Mount operation failed';
        console.error(err);
      });
    }

    function unmount() {
      document.getElementById('status').textContent = 'Unmounting...';

      fetch(`http://${window.location.hostname}:9001/stop`, {
        method: 'POST'
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('status').textContent = 'Successfully unmounted';
        selectedFile = null;
        document.getElementById('mountBtn').disabled = true;
        document.getElementById('unmountBtn').disabled = true;
        [...document.getElementById('isoList').children].forEach(child => {
          child.classList.remove('selected');
        });
      })
      .catch(err => {
        document.getElementById('status').textContent = 'Unmount operation failed';
        console.error(err);
      });
    }
  </script>
</body>
</html>